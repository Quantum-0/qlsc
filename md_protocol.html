<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Quantum-Smart-Clock: Quantum0&#39;s Led Strip Controller</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Quantum-Smart-Clock
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Smart Clock with Wi-Fi</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Quantum0's Led Strip Controller </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><em>Версия документации от 26 февраля 1:30</em> <em>Требуются правки!!!</em></p>
<h1>Оглавление</h1>
<ul>
<li>Алгоритм подключения</li>
<li>Идентификация</li>
<li>Индикация</li>
<li>Протокол</li>
</ul>
<h1>Алгоритм подключения</h1>
<div class="fragment"><div class="line">flowchart  TD</div>
<div class="line">A((Start)) --&gt; B{Settings?}</div>
<div class="line">B ==&gt;|Yes| C([Try to connect])</div>
<div class="line">B ==&gt;|No| D[Setup Mode]</div>
<div class="line">C ==&gt;|Success| E((Work))</div>
<div class="line">C --&gt;|Failed| B</div>
<div class="line">E -.-&gt;|Lost Connection| C</div>
<div class="line">D --&gt;|Recv config| C</div>
<div class="line">E --&gt;|Press button| B</div>
<div class="line">style A stroke-width:5px</div>
<div class="line">style E stroke-width:5px</div>
</div><!-- fragment --><h1>Идентификация</h1>
<p>При запуске устройство проверяет наличие UUID в памяти, если его нет - генерирует рандомный</p>
<h1>Индикация</h1>
<p><b>В качестве индикации состояния контроллера используется первый светодиод ленты и светодиод чипа</b></p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadLeft">Режим   </th><th class="markdownTableHeadCenter">Светодиод ленты   </th><th class="markdownTableHeadCenter">Светодиод чипа    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Первый запуск   </td><td class="markdownTableBodyCenter">Моргает всеми цветами   </td><td class="markdownTableBodyCenter">:white_check_mark:    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">Подключено, нет настроек   </td><td class="markdownTableBodyCenter">Желтый, моргает   </td><td class="markdownTableBodyCenter">Короткое медленное моргание    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Режим конфигурации   </td><td class="markdownTableBodyCenter">Синий, моргает   </td><td class="markdownTableBodyCenter">Быстро моргает    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">Подключение к сети   </td><td class="markdownTableBodyCenter">Зелёный, медленно моргает   </td><td class="markdownTableBodyCenter">Медленное моргание    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyLeft">Ошибка подключения   </td><td class="markdownTableBodyCenter">Красный, моргает   </td><td class="markdownTableBodyCenter">:white_check_mark:    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyLeft">Обычный режим работы   </td><td class="markdownTableBodyCenter">Не используется   </td><td class="markdownTableBodyCenter">:x:   </td></tr>
</table>
<h1>Протокол</h1>
<p>Для управления будет использоваться <b>UDP</b> на порту <b>52075</b></p>
<p>Протокол управления состоит из 3 под-протоколов:</p><ul>
<li><b>QLP Discovery</b> - протокол поиска устройств <b>QLSC</b> в сети</li>
<li><b>QLP Broadcast</b> - протокол массового управления устройствами <b>QLSC</b></li>
<li><b>QLP Control</b> - протокол управления конкретным устройством <b>QLSC</b></li>
</ul>
<p>Все внутренние пакеты шифруются с помощью <b>XOR</b> *(Слабовато, но для минимальной безопасности пойдёт)*</p>
<p>Общий формат пакета: </p><div class="fragment"><div class="line">flowchart  LR</div>
<div class="line">PID[Protocol ID] --&gt; PV[Protocol Version] --&gt; D[INTERNAL DATA] --&gt; E[CRC]</div>
<div class="line">style D stroke-width:4px</div>
</div><!-- fragment --><h2>Протокол обнаружения (<em>QLP Discovery</em>)</h2>
<p><b>Protocol ID = 1</b></p>
<p><b>Формат пакета запроса:</b> </p><div class="fragment"><div class="line">flowchart  LR</div>
<div class="line">A[ABH]</div>
</div><!-- fragment --><p> <em>ABH = Anybody here?</em></p>
<p><b>Формат пакета ответа:</b> </p><div class="fragment"><div class="line">flowchart  LR</div>
<div class="line">DI[Device ID] --&gt; UUID</div>
</div><!-- fragment --><p> <em>Device ID = ID чипа ESP</em> <em>UUID = Собственный сгенерированный ID формата UUID</em></p>
<h2>Протокол управления(<em>QLP Control</em>)</h2>
<p><b>Protocol ID = 2</b></p>
<p><b>Формат пакета запроса:</b> </p><div class="fragment"><div class="line">flowchart  LR</div>
<div class="line">IAH --&gt; DID[Device ID] --&gt; C[Command ID] --&gt; Data</div>
<div class="line">style Data stroke-dasharray: 5 5</div>
<div class="line">style Data stroke-dasharray: 5 5</div>
</div><!-- fragment --><p> <em>IAH = I am here!</em> (<em>хз, нужен ли IAH или убрать</em> :thinking:)</p>
<p><b>Список команд:</b> | Категория | Номер команды | Код команды | Описание команды | Данные | Реализовано | Поддержка BC/MC | | &mdash; | &mdash; | &mdash; | &mdash; | &mdash; | &mdash; | &mdash; | | 1.Настройки | 1.Длина ленты | 0x01 | Установка длины ленты | Unsigned int, 2 bytes | || 2.Максимальный ток | 0x02 | Установка максимального тока на ленте | Unsigned int, 2 bytes, in milliamper | || 3-15.Reserved | 0x03-0x0F | RESERVED | RESERVED | | 2.Внутренняя сеть | 1.Set master | 0x11 | Устанавливает контроллер мастером, чтоб тот рассылал пакет синхронизации (общий или в мультикаст группе) | 0 - Выкл, 1 - Мультикаст мастер, 2 - Общий мастер || 2.Get master | 0x12 | Поиск мастер-контроллера + Ответ от него | NO DATA - запрос, 0-2 - ответ | || 3.Sync Packet | 0x12 | Пакет синхронизации для синхронных режимов | NO DATA | || 4.Multicast Group | 0x14 | Устанавливает или запрашивает мультикаст группу | NO DATA for Request, 0 - Disable, 1-255 - Set || 5.Responce MCG | 0x15 | Сообщает текущую мультикаст группу | || 6-31.Reserved | 0x16-0x2F | RESERVED | RESERVED | | 3.Высокоуровневое управление | 1.Режим | 0x31 | Устанавливает режим работы | Unsigned int, 2 bytes, 0 - без режима | || 2.Цвет | 0x32 | Устанавливает или запрашивает цвет | 3 bytes, RGB | || 3.Скорость | 0x33 | Устанавливает период полного цикла анимации | Unsigned int, 4 bytes, ms | || 4.Яркость | 0x34 | Устанавливает яркость | 0-255 | || 5.Сдвиг | 0х35 | Устанавливает сдвиг цикла анимации | 0-255 | || 6.Форма | 0x36 | Указывает как подключена лента | 0 - прямая, 1 - circle, 2 - square, 3 - matrix parallel, 4 - matrix snake | || 7.Param1 | 0x37 | Установка/запрос параметра для режима | 2 bytes | || 8.Param2 | 0x38 | Установка/запрос параметра для режима | 2 bytes | || 9-31.Reserved | 0x39-0x4F | RESERVED | RESERVED | | 4.Низкоуровневое управление | 1.Set pixel color | 0x51 | Устанавливает один пиксель на ленте | Pos [2 bytes] + Color [3 bytes] || 2.Set line color | 0x52 | Закрашивает линию определённым цветом | Pos X [2 bytes] + Pos Y [2 bytes] + Color [3 bytes] || 3.Gradient | 0x53 | Закрашивает отрезок определённым цветом | Pos X [2 bytes] + Pos Y [2 bytes] + Color X [3 bytes] + Color Y [3 bytes] || 4.Fill | 0x54 | Закрашивает всю ленту | Color [3 bytes] || 5.Set line image | 0x55 | Устанавливает цвета для каждого пикселя отрезка ленты | Pos X [2 bytes] + Len [1 byte] + Colors [N * 3 bytes] || 6.Set all | 0x56 | Устанавливает на ленте все пиксели | Colors [N * 3 bytes] | 5.Сервисное управление | 1.Шифрование | 0x71 | Включает/выключает шифрование протокола | Флаги - 1) XOR 2) CRC check 3) Common Feedback (вкл/выкл общие ответы) || 2.Version | 0x72 | Запрос/получение версии | NO DATA - запрашивает версию, Unsigned int [4 bytes] - ответ (2 - major, 2 - minor) || 3.Reset ID | 0x73 | Заставляет контроллер сбросить собственный идентификатор | NO DATA / UUID - ответ | || 4.Reboot | 0x74 |Перезагрузка контроллера | NO DATA | || 5.Full reset | 0x75 | Сбрасывает все настройки | NO DATA | | 6.Time control | 1.Set time server | 0x81 | Устанавливает сервер времени | URL || 2.Set time | 0x82 | Устанавливает время вручную | HH:MM:SS || 3.Set timer | 0x83 | Устанавливает таймер | Timer ID + HH:MM + Brightness, Timer ID + EOF to turn off | || 4.Get timer | 0x84 | Запрашивает таймер(ы) | Timer ID or NO DATA for all |</p>
<p><b>Формат пакета общего ответа:</b> </p><div class="fragment"><div class="line">flowchart  LR</div>
<div class="line">DID[Device ID] --&gt; R[0x90] --&gt; RS[Response Code] --&gt; AD[Additional Data]</div>
<div class="line">style AD stroke-dasharray: 5 5</div>
</div><!-- fragment --><p> <b>Коды общих ответов:</b> </p><table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">Ответ   </th><th class="markdownTableHeadNone">Описание   </th><th class="markdownTableHeadNone">Response Code   </th><th class="markdownTableHeadNone">Data    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">OK   </td><td class="markdownTableBodyNone">Команда выполнена успешно   </td><td class="markdownTableBodyNone">0x00   </td><td class="markdownTableBodyNone">NO DATA    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">Version Error   </td><td class="markdownTableBodyNone">Ошибка версии протокола   </td><td class="markdownTableBodyNone">0x01   </td><td class="markdownTableBodyNone">NO DATA    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">CRC Error   </td><td class="markdownTableBodyNone">Ошибка вычисления контрольной суммы   </td><td class="markdownTableBodyNone">0x02   </td><td class="markdownTableBodyNone">NO DATA    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">XOR Error   </td><td class="markdownTableBodyNone">Полученный пакет был зашифрован, но на устройстве отключено шифрование   </td><td class="markdownTableBodyNone">0x03   </td><td class="markdownTableBodyNone">NO DATA    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Length Error   </td><td class="markdownTableBodyNone">Принят пакет неверной длины   </td><td class="markdownTableBodyNone">0x04   </td><td class="markdownTableBodyNone">NO DATA    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">RESERVED   </td><td class="markdownTableBodyNone">RESERVED   </td><td class="markdownTableBodyNone">0x05-0xFE   </td><td class="markdownTableBodyNone">RESERVED    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">Other Error   </td><td class="markdownTableBodyNone">Другая ошибка   </td><td class="markdownTableBodyNone">0xFF   </td><td class="markdownTableBodyNone">Error text   </td></tr>
</table>
<h2>Протокол управления(<em>QLP Broadcast</em>)</h2>
<p><b>Protocol ID = 3</b></p>
<p>Аналогичен протоколу <b>QLPC</b> за исключением того, что вместо <b>Device ID</b> передаётся <b>Broadcast/Multicast Group ID</b>. На <em>broadcast</em>/*multicast* команды контроллер <b>не</b> отправляет ответ. Некоторые команды <b>не</b> работают через BC/MC:</p><ul>
<li>1.Настройки<ul>
<li>Все</li>
</ul>
</li>
<li>2.Внутренняя сеть:<ul>
<li>1.Set master</li>
</ul>
</li>
<li>5.Сервисное управление<ul>
<li>Все</li>
</ul>
</li>
</ul>
<p>*(Возможно какие-то ещё, надо подумать)*</p>
<h2>Полная схема парсинга пакетов</h2>
<div class="fragment"><div class="line">flowchart  TD</div>
<div class="line"> </div>
<div class="line">PS((Packet Start))</div>
<div class="line">PS --&gt; HDR</div>
<div class="line">CRC --&gt; PE</div>
<div class="line">PE((Packet End))</div>
<div class="line"> </div>
<div class="line">subgraph Protocol Header</div>
<div class="line">HDR[&quot;Protocol Header (&#39;QLP&#39;)&quot;]</div>
<div class="line">HDR --&gt; PV</div>
<div class="line">PV[&quot;Protocol Version (0x01)&quot;]</div>
<div class="line">PV --&gt; H1</div>
<div class="line">PV --&gt; H2</div>
<div class="line">PV --&gt; H3</div>
<div class="line">H1[&quot;QLPD (0x01)&quot;]</div>
<div class="line">H2[&quot;QLPC (0x02)&quot;]</div>
<div class="line">H3[&quot;QLPB (0x03)&quot;]</div>
<div class="line">end</div>
<div class="line"> </div>
<div class="line">H1 --&gt; NSR[Nothing]</div>
<div class="line">NSR --&gt; ABH --&gt; NCD[Nothing] --&gt; CRC</div>
<div class="line">NSR --&gt; IAH --&gt; CI[Device ID] --&gt; DI1[UUID] --&gt; DN[Device Name] --&gt; CRC</div>
<div class="line"> </div>
<div class="line">H2 --&gt; DI2[Device ID] --&gt; CID[Command ID]</div>
<div class="line"> </div>
<div class="line">H3 --&gt; BC[&quot;Broadcast (0xFF or 0x00)&quot;] --&gt; CID</div>
<div class="line">H3 --&gt; MC[&quot;Multicast(0x01-0xFE)&quot;] --&gt; CID</div>
<div class="line"> </div>
<div class="line">DI2[Device ID] --&gt; CR[&quot;Control Response (0x90)&quot;]</div>
<div class="line"> </div>
<div class="line">CR --&gt; RC[Response Code] --&gt; RD[Responce Data] --&gt; CRC</div>
<div class="line">CID --&gt; CD[&quot;Command Data (N bytes)&quot;] --&gt; CRC</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">subgraph &quot;Sender or Receiver(s) identification&quot;</div>
<div class="line">NSR</div>
<div class="line">DI2</div>
<div class="line">BC</div>
<div class="line">MC</div>
<div class="line">end</div>
<div class="line"> </div>
<div class="line">subgraph &quot;Command Identifier&quot;</div>
<div class="line">CID</div>
<div class="line">CR</div>
<div class="line">ABH</div>
<div class="line">IAH[Nothing]</div>
<div class="line">end</div>
<div class="line"> </div>
<div class="line">subgraph &quot;Command Data&quot;</div>
<div class="line">RC</div>
<div class="line">RD</div>
<div class="line">CI</div>
<div class="line">CD</div>
<div class="line">DI1</div>
<div class="line">NCD</div>
<div class="line">DN</div>
<div class="line">end</div>
<div class="line"> </div>
<div class="line">style RD stroke-dasharray: 5 5</div>
<div class="line">style CD stroke-dasharray: 5 5</div>
<div class="line">style CRC stroke-dasharray: 5 5</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Sat Feb 25 2023 12:34:39 for Quantum-Smart-Clock by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1
</small></address>
</body>
</html>
